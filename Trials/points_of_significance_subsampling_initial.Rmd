---
title: "Modeling the Covariation between New Weekly Confirmed COVID-19 Cases and Deaths in the U.S. States: A Retrospective Analysis of 52 Weeks of Data"
author:
  - name: "Fadel M. Megahed ^[Email: fmegahed@miamioh.edu | Phone: +1-513-529-4185 | Website: <a href=\"https://miamioh.edu/fsb/directory/?up=/directory/megahefm\">Miami University Official</a>]"
    affiliation: Farmer School of Business, Miami University
bibliography: subsampling.bib
csl: apa.csl
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    number_sections: TRUE
    theme: simplex
    paged_df: TRUE
    code_folding: show
    code_download: TRUE
includes:
  in_header: structure.tex
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = TRUE,
                      progress = FALSE, 
                      verbose = FALSE,
                      dpi = 600,
                      dev = c('png', 'tiff'),
                      out.width = '100%')
options(qwraps2_markup = "markdown")

library(ggplot2); theme_set(theme_bw(base_size = 8, base_family = "Arial"))
```

# R Setup and Required Packages
In this project, the open-source R programming language [@R2021] is used to model the progression in the COVID-19 pandemic in different U.S. counties. R is maintained by an international team of developers who make the language available at [The Comprehensive R Archive Network](https://cran.r-project.org/). Readers interested in reusing our code and reproducing our results should have R installed locally on their machines. R can be installed on a number of different operating systems (see [Windows](https://cran.r-project.org/bin/windows/), [Mac](https://cran.r-project.org/bin/macosx/), and [Linux](https://cran.r-project.org/bin/linux/) for the installation instructions for these systems). We also recommend using the RStudio interface for R. The reader can [download RStudio](http://www.rstudio.com/ide) for free by following the instructions at the link. For non-R users, we recommend the [Hands-on Programming with R](https://rstudio-education.github.io/hopr/packages.html) for a brief overview of the software's functionality. Hereafter, we assume that the reader has an introductory understanding of the R programming language.

In the code chunk below, we load the packages used to support our analysis. Note that the code of this and any of the code chunks can be hidden by clicking on the 'Hide' button to facilitate the navigation. **The reader can hide all code and/or download the Rmd file associated with this document by clicking on the Code button on the top right corner of this document.** 

```{r packages, cache=FALSE}
if(require(pacman)==FALSE) install.packages("pacman") # Install pacman (if not already installed)

pacman::p_load(tidyverse, magrittr, # typical packages used in data science
               DT, pander, knitr, # for formatting and nicely printed outputs
               imbalance, rvest, # for getting some datasets
               scales, RColorBrewer, DataExplorer, plotly,# for plots
               caret, rpart, ranger, nnet, # for ML models
               conflicted) # for managing conflicts in functions with same names

# Handling conflicting function names from packages
conflict_prefer('combine', 'dplyr') # Preferring dplyr::combine over any other package
conflict_prefer('select', "dplyr") #Preferring dplyr::select over any other package
conflict_prefer("summarize", "dplyr") # similar to above but with dplyr::summarize
conflict_prefer("filter", "dplyr") # Preferring filter from dplyr

set.seed(2021) # to assist with reproducibility
sInfo = sessionInfo() # saving all the packages/functions & session Info
```

---

# Extracting and Transforming the Datasets
```{r extractData}
subsampling = c("none", "down", "up", "smote") #


datasets = list(haberman = imbalance::haberman, 
                ecoli1 = imbalance::ecoli1,
                newthyroid1 = imbalance::newthyroid1,
                yeast4 = imbalance::yeast4) %>% 
  enframe(name = "dataset", value = 'data') %>% 
  mutate(predictors = map(.x = data, .f = select, -c(contains("class" ))),
         response = map(.x = data, .f = select, contains("class")) ) %>% 
  mutate(predictors = map(.x = predictors, .f =tibble),
         response = map(.x = response, .f = extract2, 1))
```

---

# Some Custom Functions
```{r functions}
model_df = list(
  cart = mlFuncFact('rpart2'),
  knn = mlFuncFact('knn')
  ) %>%
  enframe(name = 'model', value = 'model_func')

```

---

# Running a Quick Experiment
```{r mergeData}
experiment = datasets %>% crossing(subsampling, model_df) %>% 
  mutate(parameters = pmap(list(predictors, response, subsampling),
                           .f = ~list(data = ..1, label = ..2, samplingMethod = ..3)),
         trainedModel = quiet(invoke_map(model_func, parameters)))

results = experiment %>% 
  mutate(
    accuracy = map_dbl(trainedModel, ~max(.x$results$Accuracy)),
    kappa = map_dbl(trainedModel, ~max(.x$results$Kappa)),
    roc = map_dbl(trainedModel, ~max(.x$results$ROC)),
    sensitivity = map_dbl(trainedModel, ~max(.x$results$Sens)),
    specificity = map_dbl(trainedModel, ~max(.x$results$Spec)),
    accuracySD = map_dbl(trainedModel, ~max(.x$results$AccuracySD)),
    rocSD = map_dbl(trainedModel, ~max(.x$results$ROCSD))
  )

results %<>% select(dataset, subsampling, model, accuracy, kappa, roc, sensitivity, specificity, rocSD) %>% 
  arrange(dataset, model, roc)

results %>% 
  ggplot(aes(x = subsampling, colour = model)) +
  geom_point(aes(y = roc), size = 2) +
  geom_errorbar(aes(ymin = roc - rocSD,
                    ymax = roc + rocSD)) +
  theme_bw() +
  facet_grid(cols = vars(dataset), rows = vars(model)) +
  theme(legend.position = "top")
```

---

# Conclusions
We need datasets that are more imbalanced (see [KEEL Data](https://sci2s.ugr.es/keel/imbalanced.php?order=ins#subA) for such examples). **DOWNSIDE: We will have to spend some time on cleaning those datasets.**

---

# References {-}
